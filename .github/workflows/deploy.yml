name: "Deploy on Github Pages"

on:
  workflow_run:
    workflows: ["Rust"]
    branches: [master]
    types:
      - completed

jobs:
  final-deploy:
    runs-on: ubuntu-latest
    
    steps:
      #- name: "Wait previous workflow run to be successful"
      #  uses: ahmadnassri/action-workflow-run-wait@v1
      
      - name: "Checkout repository"
        uses: actions/checkout@v2
      
      - name: "Download artifact"
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: rust.yml
          workflow_conclusion: success
          name: output-binaries
          path: crates/target/release/

      - name: "Copy and rename inox_blender dll into pyd"
        run: |
          find ./crates/target/release/ -type f -name "inox_blender.dll" | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./crates/blender/inox_blender/INOX/inox_blender.pyd"
          done
      
      - name: "Creating folders"
        run: |
          mkdir -p "./output/"
          mkdir -p "./output/wasm32/"
          mkdir -p "./output/INOX/"
          mkdir -p "./output/INOX/bin/"
          mkdir -p "./output/INOX/bin/data_raw/"

      - name: "Copy inox_blender in INOX"
        run: |
          cp -r "./crates/blender/inox_blender/INOX/" "./output/"
          
      - name: "Copy inox_viewer configs in output"
        run: |
          mkdir -p "./output/INOX/bin/data_raw/config/"
          mkdir -p "./output/INOX/bin/data_raw/config/inox_viewer/"
          cp -r "./data_raw/config/inox_viewer/" "./output/INOX/bin/data_raw/config/"

      - name: "Copy pipelines in output"
        run: |
          mkdir -p "./output/INOX/bin/data_raw/pipelines/"
          cp -r "./data_raw/pipelines/" "./output/INOX/bin/data_raw/"

      - name: "Copy shaders in output"
        run: |
          mkdir -p "./output/INOX/bin/data_raw/shaders/"
          cp -r "./data_raw/shaders/" "./output/INOX/bin/data_raw/"

      - name: "Copy .dll in output"
        run: |
          find ./crates/target/release/ -maxdepth 1 -type f -name *.dll | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./output/INOX/bin/$filename"
          done
          
      - name: "Copy .exes in output"
        run: |
          find ./crates/target/release/ -maxdepth 1 -type f -name *.exe | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./output/INOX/bin/$filename"
          done
          
      - name: "Copy .js in output"
        run: |
          find ./web/ -maxdepth 1 -type f -name *.js | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./output/wasm32/$filename"
          done

      - name: "Copy .wasm in output"
        run: |
          find ./web/ -maxdepth 1 -type f -name *.js | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./output/wasm32/$filename"
          done

      - name: "Copy wasm32 in output"
        run: |
          cp -r "./index.html" "./output/wasm32/"

      - name: Install zip
        uses: montudor/action-zip@v1

      - name: Zip INOX
        run: |
          cd "./output/"
          zip -qq -v -r INOX.zip INOX/   
          mkdir -p "./release/"
          cp "./INOX.zip" "./release/INOX.zip"     
          cd ..

      - name: "Deploy zip on Github Pages"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output/release  # default: public