name: Deploy on Github Pages

on:
  workflow_run:
    workflows: ["Rust"]
    branches: [master]
    types:
      - completed

jobs:
  final-deploy:
    runs-on: ubuntu-latest
    
    steps:
      #- name: "Wait previous workflow run to be successful"
      #  uses: ahmadnassri/action-workflow-run-wait@v1
      
      - name: "Checkout repository"
        uses: actions/checkout@v2
      
      - name: "Download artifact"
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: rust.yml
          workflow_conclusion: success
          name: output-binaries
          path: crates/target/release/

      - name: "Copy and rename nrgblender dll into pyd"
        run: |
          find ./crates/target/release/ -type f -name "nrg_blender.dll" | while read fname; do
            dirname=`dirname "$fname"`
            foldername=`basename "$dirname"`
            filename=`basename "$fname"`
            newname=`echo "$dirname" | sed -e "s/ /_/g"`
            cp "${dirname}/$filename" "./crates/blender/nrg_blender/NRG/nrg_blender.pyd"
          done
      
      - name: "Copy nrgblender in NRG"
        run: |
          cp "./crates/blender/nrg_blender/NRG/" "./output/NRG/"
          
      - name: "Copy nrg_viewer configs in NRG"
        run: |
          cp "./data_raw/config/nrg_viewer/" "./output/NRG/bin/data_raw/config/nrg_viewer/"

      - name: "Copy pipelines in NRG"
        run: |
          cp "./data_raw/pipelines/" "./output/NRG/bin/data_raw/pipelines/"

      - name: "Copy shaders in NRG"
        run: |
          cp "./data_raw/shaders/" "./output/NRG/bin/data_raw/shaders/"

      - name: "Copy binaries in NRG"
        run: |
          rsync "./crates/target/release/" "./output/NRG/bin/" -a /.cargo-lock/** /**.pdb /**.d /**.rlib /**.lib /.fingerprint/** /build/** /deps/** /examples/** /in_use/** /incremental/**

      - name: Install zip
        uses: montudor/action-zip@v1

      - name: Zip NRG
        run: zip -qq -r NRG.zip ./output/NRG/

      - name: "Deploy zip on Github Pages"
        run: |
          git checkout gh-pages
          git checkout master -- NRG.zip
          git commit -m 'Deploy NRG.zip from master to gh-pages'