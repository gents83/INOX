name: Deploy on Github Pages

on:
  workflow_run:
    workflows: ["Rust"]
    branches: [master]
    types:
      - completed

jobs:
  final-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: "Wait previous workflow run to be successful"
        uses: ahmadnassri/action-workflow-run-wait@v1
      
      - name: "Checkout repository and submodules"
        uses: actions/checkout@v2
        with:
          submodules: recursive
      
      - name: "Download artifact"
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: rust.yml
          workflow_conclusion: success
          name: output-binaries
          path: crates/target/release/

      - name: "Copy and rename nrgblender dll into pyd"
        run: |
          find ./crates/target/release/ -type f -name "nrg_blender.dll" | while read fname; do
            dirname=`dirname "$fname"`
            foldername=`basename "$dirname"`
            filename=`basename "$fname"`
            newname=`echo "$dirname" | sed -e "s/ /_/g"`
            cp "${dirname}/$filename" "./crates/blender/nrg_blender/NRG/nrg_blender.pyd"
          done

      - name: "Deploy Blender Plugin"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./crates/blender/nrg_blender/NRG/  # default: public
          destination_dir: NRG

      - name: "Copy nrg_viewer configs"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./data_raw/config/nrg_viewer  # default: public
          destination_dir: NRG/bin/data_raw/config/nrg_viewer

      - name: "Copy pipelines"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./data_raw/pipelines  # default: public
          destination_dir: NRG/bin/data_raw/pipelines

      - name: "Copy nrg_viewer configs"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./data_raw/shaders  # default: public
          destination_dir: NRG/bin/data_raw/shaders

      - name: "Deploy Binaries for OS: ${{ matrix.os }}"
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          publish_dir: ./crates/target/release/  # default: public
          destination_dir: NRG/bin
          exclude_assets: '.cargo-lock,**.pdb,**.d,**.rlib,**.lib,.fingerprint,build,deps,examples,in_use,incremental'
          keep_files: true