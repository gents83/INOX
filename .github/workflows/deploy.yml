name: "Deploy on Github Pages"

on:
  workflow_run:
    workflows: ["Rust"]
    branches: [master]
    types:
      - completed

jobs:
  final-deploy:
    runs-on: ubuntu-latest
    
    steps:
      #- name: "Wait previous workflow run to be successful"
      #  uses: ahmadnassri/action-workflow-run-wait@v1
      
      - name: "Checkout repository"
        uses: actions/checkout@v2
      
      - name: "Download artifact"
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: rust.yml
          workflow_conclusion: success
          name: output-binaries
          path: crates/target/release/

      - name: "Copy and rename sabiblender dll into pyd"
        run: |
          find ./crates/target/release/ -type f -name "sabi_blender.dll" | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./crates/blender/sabi_blender/SABI/sabi_blender.pyd"
          done
      
      - name: "Copy sabiblender in SABI"
        run: |
          mkdir -p "./output/"
          mkdir -p "./output/SABI/"
          mkdir -p "./output/SABI/bin/"
          mkdir -p "./output/SABI/bin/data_raw/"
          cp -r "./crates/blender/sabi_blender/SABI/" "./output/"
          
      - name: "Copy sabi_viewer configs in SABI"
        run: |
          mkdir -p "./output/SABI/bin/data_raw/config/"
          mkdir -p "./output/SABI/bin/data_raw/config/sabi_viewer/"
          cp -r "./data_raw/config/sabi_viewer/" "./output/SABI/bin/data_raw/config/"

      - name: "Copy pipelines in SABI"
        run: |
          mkdir -p "./output/SABI/bin/data_raw/pipelines/"
          cp -r "./data_raw/pipelines/" "./output/SABI/bin/data_raw/"

      - name: "Copy shaders in SABI"
        run: |
          mkdir -p "./output/SABI/bin/data_raw/shaders/"
          cp -r "./data_raw/shaders/" "./output/SABI/bin/data_raw/"

      - name: "Copy dlls in SABI"
        run: |
          find ./crates/target/release/ -maxdepth 1 -type f -name *.dll | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./output/SABI/bin/$filename"
          done
          
      - name: "Copy exes in SABI"
        run: |
          find ./crates/target/release/ -maxdepth 1 -type f -name *.exe | while read fname; do
            dirname=`dirname "$fname"`
            filename=`basename "$fname"`
            cp "${dirname}/$filename" "./output/SABI/bin/$filename"
          done
          
      - name: Install zip
        uses: montudor/action-zip@v1

      - name: Zip SABI
        run: |
          cd "./output/"
          zip -qq -v -r SABI.zip SABI/   
          mkdir -p "./release/"
          cp "./SABI.zip" "./release/SABI.zip"     
          cd ..

      - name: "Deploy zip on Github Pages"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output/release  # default: public